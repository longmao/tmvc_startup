<!DOCTYPE html>
<html>

<head>
    <title>TMVC Readme</title>
</head>
<link rel="stylesheet" type="text/css" href="css/default.css">
<style type="text/css">
body {
    max-width: 800px;
    padding: 20px 40px;
    margin: 0 auto;
}
@media (min-width: 0px) {
    #wmd-input {
        font-size: 16px;
    }
    p,
    li {
        font-size: 16px;
    }
}
@media (min-width: 600px) {
    #wmd-input {
        font-size: 17px;
    }
    p,
    li {
        font-size: 17px;
    }
}
@media (min-width: 1200px) {
    #wmd-input {
        font-size: 18px;
    }
    p,
    li {
        font-size: 18px;
    }
}
</style>

<body>
    <h1 id="tmvc20">TMVC2.0</h1>

    <p>TMVC是一个基于kissy的MVC框架，封装了针对web page开发的normal case以及spa两种开发模式。</p>

    <p>目前版本是2.0。</p>



    <h2 id="why-tmvc为何使用tmvc">Why TMVC为何使用TMVC</h2>

    <ol>
        <li>
            <p>基于成熟框架kissy，可采用kissy丰富又强大的模块，开发效率高</p>
        </li>
        <li>
            <p>基于自动化开发部署工具TMVCPIE，可自动生成开发starter目录，以及自动打包及部署功能，开发新页面或者模块非常方便快捷</p>
        </li>
        <li>
            <p>框架支持模块扩展，可根据项目需求进行自主开发模块，增强项目开发的灵活性。</p>
        </li>
    </ol>

    <h2 id="installment安装">Installment安装</h2>

    <ol>
        <li>
            <p>首先需要安装node</p>
        </li>
        <li>
            <p>安装tmvc-pie</p>

            <pre><code> npm install tmvcpie -g
</code></pre>
        </li>
    </ol>

    <h2 id="usage使用">Usage使用</h2>

    <ol>
        <li>
            <p>获取配置文件</p>

            <pre><code>tmvc  start
</code></pre>

            <ul>
                <li>
                    <p>当前文件夹下会生成项目的初始结构，包括生成配置文件tmvc-conf.json：</p>

                    <ul>
                        <li>
                            <p>appType可为spa、normal，分别代表单页面应用以及常规应用。</p>

                            <pre><code>        {
            "appType":"spa",
            "pageType":"html",
            "deploy": {
                "A":
                {
                    "host":"172.30.10.219",
                    "port":"8888",
                    "path":"/upload.php",
                    "username": "xxxx",
                    "password": "******",
                    "serverAppPath": "/dianyi/app/aef"
                }
            },
            "publish": {
                "backHost": "http://ips.ymtech.info",
                "frontHost": "http://feips.ymtech.info/"    
            }
</code></pre>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>
            <p>根据配置文件tmvc-conf.json，创建tmvc初始化项目</p>

            <pre><code>tmvc  -i  tmvc2.0
</code></pre>
        </li>
        <li>
            <p>新添加新页面，如新添加home页面.</p>

            <pre><code>tmvc -c  home
</code></pre>
        </li>
        <li>
            <p>根据 项目名称根路径/页面名称 进行前端打包</p>

            <pre><code>tmvc -b tmvc/index
</code></pre>
        </li>
        <li>
            <p>启动调试服务器。打开<a href="http://longmao.github.io/tmvc_startup?debug">http://longmao.github.io/tmvc_startup?debug</a> 测试调试开发(debug代表当前是调试状态，所有js css文件采用非压缩版本。)</p>

            <pre><code>tmvc release -p 8000
</code></pre>
        </li>
    </ol>

    <h2 id="module模块">Module模块</h2>



    <h3 id="garbagecollector">garbageCollector</h3>

    <p>垃圾收集器，完成对之前页面存在的timer 和 通过kissy.event.on以及kissy.event.delegate 绑定的dom 事件。</p>

    <pre><code>    var garbageCollector = {    
        startCollect: function() {
            clearTimer();
            clearNode();
            clearObject();
            clearCss(D);
        },  
        init: function() {
            window.Evt = {};
            window.Evt.on = S.Event.on;
            window.Evt.delegate = S.Event.delegate;
            S.Event.delegate = function(contextSelector, eventType, selector, func) {
                var elemenet = storeElementArray(selector);
                Evt.delegate(contextSelector, eventType, elemenet, func);
            }
            S.Event.on = function(selector, eventType, func) {
                var elemenet = storeElementArray(selector); 
                Evt.on(elemenet, eventType, func);
            }       
        }

    }
</code></pre>

    <h3 id="readtmpltool">readTmplTool</h3>

    <p>实现对模板文件的读取以及读取模板中包含include子模板</p>



    <h3 id="renderenginein">renderEnginein</h3>

    <ol>
        <li>
            <p>实现对模板中包含对class命名为sciprt-tmp的元素解析：将script-tmpl中包含的include进行替换</p>
        </li>
        <li>
            <p>增加ajax请求某一id元素时添加遮罩。</p>
        </li>
        <li>
            <p>通过renderHtml进行渲染html操作：</p>

            <ul>
                <li>首先判断html片段是否在更新，如果正在更新，则返回。</li>
                <li>通过artTempalte提供template(id,data)方法获得html字符串。</li>
                <li>通过D.query(selector, htmlElem)查找类名include-tmpl的元素。如果存在这样的元素。则读取元素的data属性，获取到要请求的include文件路径。执行include子模板请求，并将返回结果替换掉原模板中include片段。</li>
                <li>如果指定id是scirpt标签，则运用D.replaceWith用新生成的htmlElm替换掉原有scriptElm，如果不是，则运用D.html更新原有elem。</li>
                <li>判断当前id渲染是否是第一次，如果是，则执行渲染完成后的callback，并按照{id:callback}存储在TMVC.pageEvent[TMVC.getPageName()]对象中。</li>
            </ul>
        </li>
        <li>
            <p>通过init完成初始化工作：</p>

            <ul>
                <li>根据配置文件中指定的isUseMiniTmpl，决定是否获取模板的压缩文件。</li>
                <li>同步读取模板文件，将获取到的模板文件存在this.contentHtml</li>
                <li>查找模板中是否存在类名为script-tmpl的元素。如果存在，则将script-tmpl元素存在this.tmplScriptEle数组中。</li>
                <li>对this.tmplScriptEle通过replaceAll进行替换处理。将&lt;#include(‘temp.tmpl’)#&gt;片段。替换成
                    <br>
                    <code>&lt;div class="include-tmpl" data="temp.tmpl"&gt;</code>
                </li>
            </ul>
        </li>
    </ol>

    <h3 id="css">css</h3>

    <ol>
        <li>
            <p>通过页面url是否包含debug决定是否加载压缩文件。</p>
        </li>
        <li>
            <p>创建style元素。prepend插入到document.body中前面。</p>
        </li>
        <li>
            <p>设置当前页面名称。</p>
        </li>
    </ol>

    <h3 id="spa">spa</h3>

    <ol>
        <li>
            <p>通过onhashchange绑定gotoPage回调处理，这是tmvc对spa和normal两种不同应用不同的地方。</p>
        </li>
        <li>
            <p>showGotopage处理页面跳转：</p>

            <ul>
                <li>计算当前显示高度viewportHeight，显示loadingpic。</li>
                <li>通过css模块中loadCss方法加载跳转页面相关的css文件。</li>
                <li>如果当前是调试状态，则将页面指定的view、model、control三个js文件加载同步加载，将请求的结果拼装成一个字符串，运用eval进行执行javascript代码。</li>
            </ul>
        </li>
        <li>
            <p>对入口#main元素做以下处理：</p>

            <ul>
                <li>清空 #main元素</li>
                <li>在#mian中插入id为pageScript的当前页面init文件</li>
                <li>当init文件加载完成后，隐藏loadingPic。</li>
            </ul>
        </li>
    </ol>

    <h2 id="目前存在的问题">目前存在的问题</h2>

    <ol>
        <li>
            <p>hard to breakpoint debug，对于debug开发，难于断点测试，目前只能靠console or alert比较费时的debug方式</p>
        </li>
        <li>
            <p>lack of test unit 缺乏测试用例</p>
        </li>
        <li>
            <p>lack of some html5 support,such as History API pushstate ,缺少html5支持。</p>
        </li>
        <li>
            <p>lack of mobile platform support，缺少移动端支持，需要对移动端开发进行优化。</p>
        </li>
    </ol>
</body>

</html>
